`ReferenceHandler` -  настройка,  которая говорит сериализатору, как поступать с циклами и повторяющимися ссылками

Управляет обработкой циклических ссылок и сохранением ссылочной целостности


**Опции**
- `IgnoreCycles` - игнорировать циклические ссылки, они заменяются на `null`
- `Preserve` - добавляет в JSON служебные метаданные (`$id`, `$ref`, `$values`), чтобы сохранить целостность ссылок
  То есть сериализатор не ломает граф, а превращает его в сериализуемую форму


**Примеры**
Инициализируем `Person` и создаём цикл
```C#
class Person
{
    public string Name { get; set; }
    public Person? Friend { get; set; }
}

var person = new Person { Name = "John" };
person.Friend = person; // Циклическая ссылка, указывает само на себя
```


**Пример с `IgnoreCycles`**
```C#
var options = new JsonSerializerOptions
{
    ReferenceHandler = ReferenceHandler.IgnoreCycles,
    WriteIndented = true
};

string json = JsonSerializer.Serialize(john, options);
Console.WriteLine(json);
```

Результат
```C#
{
  "Name": "John",
  "Friend": null
}
```


**Пример с `Preserve`**
```C#
var options = new JsonSerializerOptions
{
    ReferenceHandler = ReferenceHandler.Preserve
};


// Сериализует с метаданными о ссылках
string json = JsonSerializer.Serialize(person, options);
```

Результат
```C#
{
  "$id": "1",
  "Name": "John",
  "Friend": { "$ref": "1" }
}
```
Тут видно: объект `John` получил `$id = 1`, а его `Friend` вместо повторного вложения стал ссылкой (`"$ref": "1"`).  
При десериализации структура полностью восстановится, включая цикл

---



**Описание проблемы, которую решает настройка**
JSON - это дерево (объекты, массивы, примитивы). 
Но в C# у нас часто граф объектов: один объект может ссылаться на другой, а иногда встречаются циклы

Создаём цикл и получаем исключение
```C#
var john = new Person { Name = "John" };
john.Friend = john; // Свойство указывает само на себя


// Исключение
string json = JsonSerializer.Serialize(john);
```

Если просто попробовать сериализовать, то получим исключение `System.Text.Json.JsonException: A possible object cycle was detected`
Потому что сериализатор пытается бесконечно обходить объект и зацикливается